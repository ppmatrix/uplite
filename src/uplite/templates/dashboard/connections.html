{% extends "base.html" %}

{% block title %}Connections - UpLite{% endblock %}

{% block head %}
<style>
.connection-card { margin-bottom: 1rem; }
.connection-status { font-weight: bold; }
.status-up { color: #28a745; }
.status-down { color: #dc3545; }
.status-unknown { color: #6c757d; }
.connection-actions { text-align: right; }
.status-indicator {
    width: 12px; height: 12px; border-radius: 50%;
    display: inline-block; margin-right: 0.5rem;
}
.status-success { background-color: #28a745; }
.status-warning { background-color: #ffc107; }
.status-danger { background-color: #dc3545; }
.status-secondary { background-color: #6c757d; }
/* Connection icons in cards */
.connection-icon-small {
    width: 24px; height: 24px; border-radius: 4px;
    object-fit: cover;
}
.connection-icon-placeholder {
    font-size: 18px; color: #6c757d; width: 24px; text-align: center;
/* Phase 2 Enhanced Styling */
.status-dashboard .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-filter-bar .input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.search-filter-bar .form-control:focus,
.search-filter-bar .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Enhanced connection cards */
.connection-card .card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.connection-card .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #dee2e6;
}

.connection-card .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    font-weight: 500;
}

.connection-card .card-body {
    background-color: #fff;
}

/* Action buttons spacing */
.connection-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}


/* Card height consistency fix */
.connection-card {
    display: flex;
    flex-direction: column;
}

.connection-card .card {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.connection-card .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.connection-card .connection-actions {
    margin-top: auto;
}

/* Error message styling - truncate long messages */
.connection-card .text-danger {
    font-size: 0.75rem;
    line-height: 1.2;
    max-height: 2.4rem;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;

/* Status area styling (error and working states) */
.connection-card .text-success {
    font-size: 0.75rem;
    line-height: 1.2;
    font-weight: 500;
}

.connection-card .bi-check-circle-fill {
    color: #198754;
}

.connection-card .bi-exclamation-triangle-fill {
    color: #dc3545;
}
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    word-break: break-word;
}
.connection-actions .btn {
    flex: 1;
    min-width: auto;
}

/* Status indicators enhanced */
.status-indicator {
    box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
}
}
}

p.card-text {
    font-size: 1.1rem !important;
}

.connection-card .card-text {
    font-size: 1.1rem !important;
    line-height: 1.4 !important;
    margin-bottom: 1rem !important;
/* Font size adjustments */
.card-header strong { font-size: 1.3rem !important; }
.card-text { font-size: 1.1rem !important; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="clean-dashboard-title"><i class="bi bi-wifi"></i> Connection Management</h1>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addConnectionModal">
        <i class="bi bi-plus-circle"></i> Add Connection
    </button>
</div>

<!-- Status Dashboard Summary -->
<div class="row mb-4 status-dashboard">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body py-3">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-collection text-primary fs-4 me-2"></i>
                            <div>
                                <div class="fs-5 fw-bold text-primary">{{ connections|length }}</div>
                                <small class="text-muted">Total Connections</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-check-circle text-success fs-4 me-2"></i>
                            <div>
                                <div class="fs-5 fw-bold text-success">
                                    {{ connections|selectattr("last_status", "equalto", "up")|list|length }}
                                </div>
                                <small class="text-muted">Online</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-x-circle text-danger fs-4 me-2"></i>
                            <div>
                                <div class="fs-5 fw-bold text-danger">
                                    {{ connections|selectattr("last_status", "equalto", "down")|list|length }}
                                </div>
                                <small class="text-muted">Offline</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-question-circle text-secondary fs-4 me-2"></i>
                            <div>
                                <div class="fs-5 fw-bold text-secondary">
                                    {{ connections|rejectattr("last_status")|list|length + connections|selectattr("last_status", "equalto", "unknown")|list|length }}
                                </div>
                                <small class="text-muted">Unknown</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="row mb-4 status-dashboard">
    <div class="col-md-4">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="connectionSearch" placeholder="Search connections...">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="up">ðŸŸ¢ Online</option>
            <option value="down">ðŸ”´ Offline</option>
            <option value="unknown">âšª Unknown</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="typeFilter">
            <option value="">All Types</option>
            <option value="http">HTTP/HTTPS</option>
            <option value="ping">Ping</option>
            <option value="tcp">TCP Port</option>
            <option value="database">Database</option>
        </select>
    </div>
    <div class="col-md-2">
        <button class="btn btn-outline-secondary w-100" id="clearFilters">
            <i class="bi bi-x-lg"></i> Clear
        </button>
    </div>
</div>


<div class="row">
    {% for connection in connections %}
    <div class="col-xl-4 col-lg-6 col-md-6 connection-card">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <!-- Connection Icon -->
                    {% if connection.logo_filename %}
                    <img src="/static/images/connections/{{ connection.logo_filename }}" 
                         class="connection-icon-small me-2" alt="{{ connection.name }}">
                    {% else %}
                    <i class="bi bi-globe connection-icon-placeholder me-2"></i>
                    {% endif %}
                    <strong>{{ connection.name }}</strong>
                    <span class="badge bg-secondary ms-2">{{ connection.connection_type }}</span>
                </div>
                <div>
                    <span class="status-indicator status-{{ connection.get_status_color() }}"></span>
                    <span class="connection-status status-{{ connection.last_status or 'unknown' }}">
                        {{ connection.last_status or 'Unknown' }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <p class="card-text">{{ connection.description or 'No description' }}</p>
                <div class="row">
                    <div class="col-sm-6">
                        <small class="text-muted">
                            <strong>Target:</strong> {{ connection.target }}{% if connection.port %}:{{ connection.port }}{% endif %}
                        </small>
                    </div>
                    <div class="col-sm-6">
                        <small class="text-muted"><strong>Timeout:</strong> {{ connection.timeout }}s</small>
                    </div>
                </div>
                {% if connection.last_check %}
                <div class="row mt-2">
                    <div class="col-sm-6">
                        <small class="text-muted">
                            <strong>Last Check:</strong> {{ connection.last_check.strftime('%b %d, %H:%M') if connection.last_check else 'Never checked' }}
                        </small>
                    </div>
                    {% if connection.last_response_time %}
                    <div class="col-sm-6">
                        <small class="text-muted">
                            <strong>Response Time:</strong> {{ "%.0f"|format(connection.last_response_time) }}ms
                        </small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                <!-- Status Area (always present for consistent alignment) -->
                <div class="row mt-2">
                    <div class="col-12">
                        {% if connection.last_error %}
                        <small class="text-danger" title="{{ connection.last_error }}">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                            <strong>Error:</strong> {{ connection.last_error }}
                        </small>
                        {% else %}
                        <small class="text-success">
                            <i class="bi bi-check-circle-fill me-1"></i>
                            <strong>Working</strong>
                        </small>
                        {% endif %}
                    </div>
                </div>
                
                <div class="connection-actions mt-3">
                    <button class="btn btn-sm btn-success" onclick="openConnection({target: '{{ connection.target }}', port: {{ connection.port or 'null' }}})" title="Open {{ connection.name }}">
                        <i class="bi bi-box-arrow-up-right"></i> Open
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="checkConnection({{ connection.id }})">
                        <i class="bi bi-arrow-clockwise"></i> Check Now
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editConnection({{ connection.id }})">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteConnection({{ connection.id }})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            No connections configured yet. Click "Add Connection" to start monitoring services.
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Connection Modal -->
<div class="modal fade" id="addConnectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Connection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addConnectionForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Connection Name *</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Connection Type *</label>
                                <select class="form-select" name="connection_type" required>
                                    <option value="">Select type...</option>
                                    <option value="http">HTTP/HTTPS</option>
                                    <option value="ping">Ping</option>
                                    <option value="tcp">TCP Port</option>
                                    <option value="database">Database</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description">
                    </div>

                    <!-- Enhanced Image Selection System -->
                    <div class="image-selection-container">
                        <h6><i class="bi bi-image"></i> Connection Image</h6>
                        
                        <!-- Suggestion Section (initially hidden) -->
                        <div class="suggestion-section" id="suggestion-section" style="display: none;">
                            <!-- Content populated by JavaScript -->
                        </div>

                        <!-- Browse Icons Section -->
                        <div class="browse-icons-section">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="image_option" id="browse_icons" value="browse">
                                <label class="form-check-label" for="browse_icons">
                                    <i class="bi bi-grid-3x3-gap"></i> Choose from available icons
                                </label>
                            </div>
                            <div class="icon-browser" id="icon-browser" style="display: none;">
                                <div class="search-box">
                                    <input type="text" class="form-control form-control-sm" id="icon-search" 
                                           placeholder="Search icons... (e.g., docker, nginx, mysql)">
                                </div>
                                <div class="icon-grid" id="icon-grid">
                                    <!-- Icons populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Upload Custom Image Section -->
                        <div class="upload-section">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="image_option" id="upload_custom" value="upload">
                                <label class="form-check-label" for="upload_custom">
                                    <i class="bi bi-upload"></i> Upload custom image
                                </label>
                            </div>
                            <div class="upload-input" id="upload-input" style="display: none;">
                                <input type="file" class="form-control" name="logo" accept="image/*">
                                <small class="form-text text-muted">PNG, JPG, GIF up to 2MB</small>
                            </div>
                        </div>

                        <!-- Hidden field for selected icon -->
                        <input type="hidden" name="logo_choice" id="logo_choice">
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Target *</label>
                                <input type="text" class="form-control" name="target" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Port</label>
                                <input type="number" class="form-control" name="port" min="1" max="65535">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Timeout (seconds)</label>
                                <input type="number" class="form-control" name="timeout" value="10" min="1" max="60">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Check Interval (seconds)</label>
                                <input type="number" class="form-control" name="check_interval" value="60" min="30" max="3600">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Connection</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Include the image selector JavaScript -->
<script src="{{ url_for('static', filename='js/image-selector.js') }}"></script>

<script>
// Simple, working JavaScript functions

// Search and Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('connectionSearch');
    const statusFilter = document.getElementById('statusFilter');
    const typeFilter = document.getElementById('typeFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const connectionCards = document.querySelectorAll('.connection-card');

    // Function to filter connections
    function filterConnections() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        
        let visibleCount = 0;
        
        connectionCards.forEach(card => {
            const cardElement = card.querySelector('.card');
            
            // Get connection data from the card
            const connectionName = cardElement.querySelector('strong').textContent.toLowerCase();
            const connectionStatus = cardElement.querySelector('.connection-status').textContent.toLowerCase().trim();
            const connectionType = cardElement.querySelector('.badge').textContent.toLowerCase();
            
            // Apply filters
            let showCard = true;
            
            // Search filter
            if (searchTerm && !connectionName.includes(searchTerm)) {
                showCard = false;
            }
            
            // Status filter
            if (statusFilter && connectionStatus !== statusFilter) {
                showCard = false;
            }
            
            // Type filter  
            if (typeFilter && !connectionType.includes(typeFilter)) {
                showCard = false;
            }
            
            // Show/hide card
            if (showCard) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Update the "no connections" message
        updateNoConnectionsMessage(visibleCount);
    }
    
    function updateNoConnectionsMessage(visibleCount) {
        let noConnectionsDiv = document.querySelector('.no-connections-message');
        
        if (visibleCount === 0 && connectionCards.length > 0) {
            if (!noConnectionsDiv) {
                noConnectionsDiv = document.createElement('div');
                noConnectionsDiv.className = 'col-12 no-connections-message';
                noConnectionsDiv.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="bi bi-funnel"></i>
                        No connections match the current filters. Try adjusting your search or filters.
                    </div>
                `;
                document.querySelector('.row').appendChild(noConnectionsDiv);
            }
            noConnectionsDiv.style.display = '';
        } else if (noConnectionsDiv) {
            noConnectionsDiv.style.display = 'none';
        }
    }
    
    function clearAllFilters() {
        searchInput.value = '';
        statusFilter.value = '';
        typeFilter.value = '';
        filterConnections();
    }
    
    // Event listeners
    searchInput.addEventListener('input', filterConnections);
    statusFilter.addEventListener('change', filterConnections);
    typeFilter.addEventListener('change', filterConnections);
    clearFiltersBtn.addEventListener('click', clearAllFilters);
});


function buildConnectionUrl(conn) {
    let url = conn.target;
    
    // Add port if specified and not already in URL
    if (conn.port && !url.includes(":" + conn.port)) {
        // Check if URL already has protocol
        if (url.startsWith("http://") || url.startsWith("https://")) {
            // Parse URL to add port correctly
            try {
                const urlObj = new URL(url);
                if (!urlObj.port) {  // Only add port if not already specified
                    urlObj.port = conn.port;
                    url = urlObj.toString();
                }
            } catch (e) {
                // If URL parsing fails, fall back to simple concatenation
                url = url + ":" + conn.port;
            }
        } else {
            // No protocol, add port to hostname
            url = url + ":" + conn.port;
        }
    }
    
    // Add protocol if missing
    if (!url.startsWith("http://") && !url.startsWith("https://")) {
        url = "https://" + url;
    }
    
    return url;
}

function openConnection(connectionData) {
    const url = buildConnectionUrl(connectionData);
    window.open(url, '_blank');
}


function checkConnection(connectionId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Checking...';
    button.disabled = true;
    
    fetch('/api/connections/' + connectionId + '/check', {
        method: 'POST',
        credentials: 'same-origin'
    })
            .then(response => {
                return response.json();
            })
    .then(data => {
        if (typeof UpLite !== 'undefined' && UpLite.notify) {
            UpLite.notify.success('Connection checked successfully');
        } else {
            alert('Connection checked successfully');
        }
        setTimeout(() => location.reload(), 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        if (typeof UpLite !== 'undefined' && UpLite.notify) {
            UpLite.notify.error('Failed to check connection');
        } else {
            alert('Failed to check connection');
        }
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function editConnection(connectionId) {
    console.log("editConnection called with ID:", connectionId);
    const button = event.target.closest("button");
    const originalText = button.innerHTML;
    button.innerHTML = "<i class=\"bi bi-arrow-clockwise\"></i> Loading...";
    button.disabled = true;
    
    fetch("/api/connections/" + connectionId, {
        method: "GET",
        credentials: "same-origin"
    })
    .then(response => response.json())
    .then(data => {
        // Create an enhanced edit overlay with image selection
        createEnhancedEditOverlay(data);
        
        // Reset button
        button.innerHTML = originalText;
        button.disabled = false;
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Failed to load connection data");
        
        // Reset button on error
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function createEnhancedEditOverlay(data) {
    // Remove any existing overlay
    const existingOverlay = document.getElementById("editOverlay");
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    // Create overlay
    const overlay = document.createElement("div");
    overlay.id = "editOverlay";
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    `;
    
    // Create form container (larger to accommodate all fields)
    const formContainer = document.createElement("div");
    formContainer.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    `;
    
    formContainer.innerHTML = `
        <!-- Modal Header -->
        <div style="padding: 1.5rem 2rem 0 2rem; border-bottom: 1px solid #dee2e6; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #495057;">
                    <i class="bi bi-pencil-square"></i> Edit Connection
                </h4>
                <button type="button" id="editHeaderCloseButton"
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">
                    &times;
                </button>
            </div>
            <p style="margin: 0.5rem 0 1rem 0; color: #6c757d; font-size: 0.9rem;">
                Modify connection settings and monitoring parameters
            </p>
        </div>
        
        <!-- Modal Body -->
        <div style="padding: 0 2rem;">
            <form id="enhancedEditForm">
                <input type="hidden" id="editId" value="${data.id}">
                
                <!-- Basic Information Row -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Connection Name *</label>
                            <input type="text" class="form-control" id="editName" value="${data.name}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Connection Type *</label>
                            <select class="form-select" id="editConnectionType" required>
                                <option value="http" ${data.connection_type === 'http' ? 'selected' : ''}>HTTP/HTTPS</option>
                                <option value="ping" ${data.connection_type === 'ping' ? 'selected' : ''}>Ping</option>
                                <option value="tcp" ${data.connection_type === 'tcp' ? 'selected' : ''}>TCP Port</option>
                                <option value="database" ${data.connection_type === 'database' ? 'selected' : ''}>Database</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="editDesc" value="${data.description || ''}" 
                           placeholder="Brief description of this connection">
                </div>

                <!-- Enhanced Image Selection System -->
                <div class="image-selection-container">
                    <h6><i class="bi bi-image"></i> Connection Image</h6>
                    
                    <!-- Current Image Display -->
                    ${data.logo_filename ? `
                    <div class="current-image-preview mb-3" style="padding: 0.75rem; background: #f8f9fa; border-radius: 0.375rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <img src="/static/images/connections/${data.logo_filename}" alt="Current image" 
                                 style="max-width: 32px; max-height: 32px; object-fit: contain;">
                            <span style="font-size: 0.875rem; color: #6c757d;">Current: ${data.logo_filename}</span>
                        </div>
                    </div>
                    ` : '<p style="font-size: 0.875rem; color: #6c757d; margin-bottom: 1rem;">No image currently set</p>'}
                    
                    <!-- Image Options -->
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="edit_image_option" id="edit_keep_current" value="keep" checked>
                        <label class="form-check-label" for="edit_keep_current">
                            <i class="bi bi-check-circle"></i> Keep current image
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="edit_image_option" id="edit_browse_icons" value="browse">
                        <label class="form-check-label" for="edit_browse_icons">
                            <i class="bi bi-grid-3x3-gap"></i> Choose from available icons
                        </label>
                    </div>
                    <div class="icon-browser" id="edit-icon-browser" style="display: none; margin-top: 0.75rem;">
                        <div class="search-box">
                            <input type="text" class="form-control form-control-sm" id="edit-icon-search" 
                                   placeholder="Search icons... (e.g., ${data.name.toLowerCase()})">
                        </div>
                        <div class="icon-grid" id="edit-icon-grid">
                            <!-- Icons populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="edit_image_option" id="edit_upload_new" value="upload">
                        <label class="form-check-label" for="edit_upload_new">
                            <i class="bi bi-upload"></i> Upload custom image
                        </label>
                    </div>
                    <div id="edit_upload_section" style="display: none; margin-top: 0.75rem;">
                        <input type="file" class="form-control" id="editLogo" accept="image/*">
                        <small class="form-text text-muted">PNG, JPG, GIF up to 2MB</small>
                    </div>

                    <!-- Hidden field for selected icon -->
                    <input type="hidden" id="edit_logo_choice">
                </div>

                <!-- Target and Port Row -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Target *</label>
                            <input type="text" class="form-control" id="editTarget" value="${data.target}" required
                                   placeholder="e.g., 10.10.77.51, pve.local, https://grafana.local">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-control" id="editPort" 
                                   value="${data.port || ''}" min="1" max="65535"
                                   placeholder="e.g., 8006, 3000">
                        </div>
                    </div>
                </div>

                <!-- Monitoring Settings Row -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Timeout (seconds)</label>
                            <input type="number" class="form-control" id="editTimeout" 
                                   value="${data.timeout || 10}" min="1" max="60">
                            <small class="form-text text-muted">Connection timeout in seconds</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Check Interval (seconds)</label>
                            <input type="number" class="form-control" id="editCheckInterval" 
                                   value="${data.check_interval || 60}" min="30" max="3600">
                            <small class="form-text text-muted">How often to check this connection</small>
                        </div>
                    </div>
                </div>

                <!-- Status Toggle -->
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editIsActive" 
                               ${data.is_active !== false ? 'checked' : ''}>
                        <label class="form-check-label" for="editIsActive">
                            <strong>Active Monitoring</strong>
                            <small class="d-block text-muted">Enable/disable monitoring for this connection</small>
                        </label>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Modal Footer -->
        <div style="padding: 1.5rem 2rem; border-top: 1px solid #dee2e6; margin-top: 1.5rem; background: #f8f9fa;">
            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-secondary" id="editCancelButton">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="submit" class="btn btn-warning" form="enhancedEditForm" id="editSubmitButton">
                    <i class="bi bi-check-circle"></i> Update Connection
                </button>
            </div>
        </div>
    `;
    
    overlay.appendChild(formContainer);
    document.body.appendChild(overlay);
    
    // Initialize image selection functionality for edit form
    initializeEditImageSelection();
    
    // Add form handler with comprehensive field handling
    document.getElementById("enhancedEditForm").addEventListener("submit", function(e) {
        e.preventDefault();
        submitEnhancedEditForm(data.id);
    });
    
    // Add header close button handler
    document.getElementById("editHeaderCloseButton").addEventListener("click", function() {
        closeEditOverlay();
    });
    
    // Add cancel button handler
    document.getElementById("editCancelButton").addEventListener("click", function() {
        closeEditOverlay();
    });
    
    // Handle image option changes for edit form
    document.querySelectorAll('input[name="edit_image_option"]').forEach(radio => {
        radio.addEventListener('change', function() {
            handleEditImageOptionChange(this.value);
        });
    });
    
    // Close on overlay click (but not on form container)
    overlay.addEventListener("click", function(e) {
        if (e.target === overlay) {
            closeEditOverlay();
        }
    });
    
    // Add keyboard shortcut (Escape to close)
    const escapeHandler = function(e) {
        if (e.key === 'Escape' && document.getElementById('editOverlay')) {
            closeEditOverlay();
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);
}

function initializeEditImageSelection() {
    // Initialize icon search functionality
    const searchInput = document.getElementById('edit-icon-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            searchEditIcons(e.target.value);
        });
    }
}

function handleEditImageOptionChange(option) {
    const iconBrowser = document.getElementById('edit-icon-browser');
    const uploadSection = document.getElementById('edit_upload_section');
    const logoChoiceInput = document.getElementById('edit_logo_choice');

    // Hide all sections first
    if (iconBrowser) iconBrowser.style.display = 'none';
    if (uploadSection) uploadSection.style.display = 'none';

    switch (option) {
        case 'keep':
            if (logoChoiceInput) logoChoiceInput.value = '';
            break;
        case 'browse':
            if (iconBrowser) {
                iconBrowser.style.display = 'block';
                loadEditAvailableIcons();
            }
            if (logoChoiceInput) logoChoiceInput.value = '';
            break;
        case 'upload':
            if (uploadSection) uploadSection.style.display = 'block';
            if (logoChoiceInput) logoChoiceInput.value = '';
            break;
    }
}

async function loadEditAvailableIcons(searchQuery = '') {
    const iconGrid = document.getElementById('edit-icon-grid');
    if (!iconGrid) return;

    iconGrid.className = 'icon-grid loading';
    iconGrid.innerHTML = '';

    try {
        const url = searchQuery
            ? `/api/images/search?q=${encodeURIComponent(searchQuery)}&limit=100`
            : '/api/images/available';

        const response = await fetch(url, {
            method: 'GET',
            credentials: 'same-origin'
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        let icons;
        if (searchQuery) {
            icons = data.results || [];
        } else {
            icons = (data.icons || []).map(i => i.filename);
        }

        renderEditIconGrid(icons);

    } catch (error) {
        console.error('Error loading icons:', error);
        iconGrid.className = 'icon-grid empty';
        iconGrid.innerHTML = '<div class="text-center text-muted p-3">Failed to load icons</div>';
    }
}

function renderEditIconGrid(icons) {
    const iconGrid = document.getElementById('edit-icon-grid');
    if (!iconGrid) return;

    iconGrid.className = 'icon-grid';

    if (icons.length === 0) {
        iconGrid.className = 'icon-grid empty';
        iconGrid.innerHTML = '';
        return;
    }

    iconGrid.innerHTML = '';

    icons.forEach(iconName => {
        const iconElement = document.createElement('div');
        iconElement.className = 'icon-option';
        iconElement.dataset.icon = iconName;

        const displayName = iconName.replace(/\.(png|jpg|jpeg|gif|svg)$/i, '');

        iconElement.innerHTML = `
            <img src="/static/apps_icons/${iconName}" alt="${displayName}" 
                 onerror="this.parentElement.style.display='none';">
            <small>${displayName}</small>
        `;

        iconElement.addEventListener('click', () => selectEditIcon(iconElement));
        iconGrid.appendChild(iconElement);
    });
}

function selectEditIcon(iconElement) {
    const iconGrid = document.getElementById('edit-icon-grid');
    const logoChoiceInput = document.getElementById('edit_logo_choice');

    iconGrid.querySelectorAll('.icon-option').forEach(el => {
        el.classList.remove('selected');
    });

    iconElement.classList.add('selected');
    const iconName = iconElement.dataset.icon;

    if (logoChoiceInput) {
        logoChoiceInput.value = iconName;
    }

    const browseRadio = document.getElementById('edit_browse_icons');
    if (browseRadio) {
        browseRadio.checked = true;
    }
}

function searchEditIcons(query) {
    clearTimeout(window.editSearchTimeout);
    window.editSearchTimeout = setTimeout(() => {
        loadEditAvailableIcons(query);
    }, 300);
}

function submitEnhancedEditForm(connectionId) {
    const formData = new FormData();
    
    // Add all form fields with proper validation
    const fields = {
        name: document.getElementById("editName").value.trim(),
        description: document.getElementById("editDesc").value.trim(),
        connection_type: document.getElementById("editConnectionType").value,
        target: document.getElementById("editTarget").value.trim(),
        port: document.getElementById("editPort").value.trim(),
        timeout: document.getElementById("editTimeout").value,
        check_interval: document.getElementById("editCheckInterval").value,
        is_active: document.getElementById("editIsActive").checked
    };
    
    // Validate required fields
    if (!fields.name) {
        alert("Connection name is required");
        return;
    }
    if (!fields.target) {
        alert("Target is required");
        return;
    }
    
    // Add fields to form data
    Object.keys(fields).forEach(key => {
        if (fields[key] !== '' && fields[key] !== null && fields[key] !== undefined) {
            formData.append(key, fields[key]);
        }
    });
    
    // Handle image selection
    const imageOption = document.querySelector('input[name="edit_image_option"]:checked')?.value;
    
    if (imageOption === 'upload') {
        const logoFile = document.getElementById("editLogo").files[0];
        if (logoFile) {
            formData.append("logo", logoFile);
        }
    } else if (imageOption === 'browse') {
        const logoChoice = document.getElementById("edit_logo_choice").value;
        if (logoChoice) {
            formData.append("logo_choice", logoChoice);
        }
    }
    
    // Show loading state
    const submitButton = document.getElementById("editSubmitButton");
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite;"></i> Updating...';
    submitButton.disabled = true;
    
    fetch("/api/connections/" + connectionId, {
        method: "PUT",
        credentials: "same-origin",
        body: formData
    })
    .then(response => {
        console.log("Response status:", response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            if (typeof UpLite !== 'undefined' && UpLite.notify) {
                UpLite.notify.success('Connection updated successfully!');
            } else {
                alert("Connection updated successfully!");
            }
            closeEditOverlay();
            location.reload();
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Failed to update connection: " + error.message);
    })
    .finally(() => {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
}
function deleteConnection(connectionId) {
    if (confirm('Are you sure you want to delete this connection?')) {
        console.log('Attempting to delete connection ID:', connectionId);
        
        fetch('/api/connections/' + connectionId, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            console.log('Delete response ok:', response.ok);
            
            if (response.ok) {
                return response.json().then(data => {
                    console.log('Delete success response:', data);
                    if (typeof UpLite !== 'undefined' && UpLite.notify) {
                        UpLite.notify.success('Connection deleted successfully');
                    } else {
                        alert('Connection deleted successfully');
                    }
                    location.reload();
                });
            } else {
                // Handle non-OK responses
                return response.text().then(text => {
                    console.error('Delete failed with status:', response.status);
                    console.error('Delete response body:', text);
                    
                    let errorMessage = 'Failed to delete connection';
                    try {
                        const errorData = JSON.parse(text);
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        // Not JSON, use the text as-is
                        if (text.length > 0 && text.length < 100) {
                            errorMessage = text;
                        }
                    }
                    
                    if (typeof UpLite !== 'undefined' && UpLite.notify) {
                        UpLite.notify.error('Delete failed: ' + errorMessage);
                    } else {
                        alert('Delete failed: ' + errorMessage);
                    }
                });
            }
        })
        .catch(error => {
            console.error('Delete request failed:', error);
            if (typeof UpLite !== 'undefined' && UpLite.notify) {
                UpLite.notify.error('Network error: Failed to delete connection');
            } else {
                alert('Network error: Failed to delete connection');
            }
        });
    }
}

// Form handlers
document.addEventListener('DOMContentLoaded', function() {
    // Add connection form
    const addForm = document.getElementById('addConnectionForm');
    if (addForm) {
        addForm.addEventListener("submit", function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            console.log("Form fields:", Array.from(formData.entries()));
            
            // Convert empty strings to null for non-file fields
            if (!formData.get("port")) formData.delete("port");
            if (!formData.get("description")) formData.delete("description");
            
            fetch("/api/connections", {
                method: "POST",
                credentials: "same-origin",
                body: formData  // Send FormData directly for file upload support
            })
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    if (typeof UpLite !== "undefined" && UpLite.notify) {
                        UpLite.notify.error(data.error);
                    } else {
                        alert(data.error);
                    }
                } else {
                    if (typeof UpLite !== "undefined" && UpLite.notify) {
                        UpLite.notify.success("Connection added successfully");
                    } else {
                        alert("Connection added successfully");
                    }
                    
                    // Reset the image selector
                    if (window.addConnectionImageSelector) {
                        window.addConnectionImageSelector.reset();
                    }
                    
                    // Close modal and refresh
                    const modal = bootstrap.Modal.getInstance(document.getElementById("addConnectionModal"));
                    if (modal) modal.hide();
                    location.reload();
                }
            })
            .catch(error => {
                console.error("Error:", error);
                if (typeof UpLite !== "undefined" && UpLite.notify) {
                    UpLite.notify.error("Failed to add connection");
                } else {
                    alert("Failed to add connection");
                }
            });
        });
    }
});

function closeEditOverlay() {
    const overlay = document.getElementById("editOverlay");
    if (overlay) {
        overlay.remove();
    }
}
</script>
{% endblock %}

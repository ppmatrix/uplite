{% extends "base.html" %}

{% block title %}Connections - UpLite{% endblock %}

{% block head %}
<style>
.connection-card { margin-bottom: 1rem; }
.connection-status { font-weight: bold; }
.status-up { color: #28a745; }
.status-down { color: #dc3545; }
.status-unknown { color: #6c757d; }
.connection-actions { text-align: right; }
.status-indicator {
    width: 12px; height: 12px; border-radius: 50%;
    display: inline-block; margin-right: 0.5rem;
}
.status-success { background-color: #28a745; }
.status-warning { background-color: #ffc107; }
.status-danger { background-color: #dc3545; }
.status-secondary { background-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="clean-dashboard-title"><i class="bi bi-wifi"></i> Connection Management</h1>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addConnectionModal">
        <i class="bi bi-plus-circle"></i> Add Connection
    </button>
</div>

<div class="row">
    {% for connection in connections %}
    <div class="col-lg-6 connection-card">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ connection.name }}</strong>
                    <span class="badge bg-secondary ms-2">{{ connection.connection_type }}</span>
                </div>
                <div>
                    <span class="status-indicator status-{{ connection.get_status_color() }}"></span>
                    <span class="connection-status status-{{ connection.last_status or 'unknown' }}">
                        {{ connection.last_status or 'Unknown' }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <p class="card-text">{{ connection.description or 'No description' }}</p>
                <div class="row">
                    <div class="col-sm-6">
                        <small class="text-muted">
                            <strong>Target:</strong> {{ connection.target }}{% if connection.port %}:{{ connection.port }}{% endif %}
                        </small>
                    </div>
                    <div class="col-sm-6">
                        <small class="text-muted"><strong>Timeout:</strong> {{ connection.timeout }}s</small>
                    </div>
                </div>
                {% if connection.last_check %}
                <div class="row mt-2">
                    <div class="col-sm-6">
                        <small class="text-muted">
                            <strong>Last Check:</strong> {{ connection.last_check.strftime('%Y-%m-%d %H:%M:%S') }}
                        </small>
                    </div>
                    {% if connection.last_response_time %}
                    <div class="col-sm-6">
                        <small class="text-muted">
                            <strong>Response Time:</strong> {{ "%.0f"|format(connection.last_response_time) }}ms
                        </small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% if connection.last_error %}
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-danger"><strong>Last Error:</strong> {{ connection.last_error }}</small>
                    </div>
                </div>
                {% endif %}
                
                <div class="connection-actions mt-3">
                    <button class="btn btn-sm btn-primary" onclick="checkConnection({{ connection.id }})">
                        <i class="bi bi-arrow-clockwise"></i> Check Now
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editConnection({{ connection.id }})">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteConnection({{ connection.id }})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            No connections configured yet. Click "Add Connection" to start monitoring services.
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Connection Modal -->
<div class="modal fade" id="addConnectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Connection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addConnectionForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Connection Name *</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Connection Type *</label>
                                <select class="form-select" name="connection_type" required>
                                    <option value="">Select type...</option>
                                    <option value="http">HTTP/HTTPS</option>
                                    <option value="ping">Ping</option>
                                    <option value="tcp">TCP Port</option>
                                    <option value="database">Database</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description">
                    </div>

                    <!-- Enhanced Image Selection System -->
                    <div class="image-selection-container">
                        <h6><i class="bi bi-image"></i> Connection Image</h6>
                        
                        <!-- Suggestion Section (initially hidden) -->
                        <div class="suggestion-section" id="suggestion-section" style="display: none;">
                            <!-- Content populated by JavaScript -->
                        </div>

                        <!-- Browse Icons Section -->
                        <div class="browse-icons-section">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="image_option" id="browse_icons" value="browse">
                                <label class="form-check-label" for="browse_icons">
                                    <i class="bi bi-grid-3x3-gap"></i> Choose from available icons
                                </label>
                            </div>
                            <div class="icon-browser" id="icon-browser" style="display: none;">
                                <div class="search-box">
                                    <input type="text" class="form-control form-control-sm" id="icon-search" 
                                           placeholder="Search icons... (e.g., docker, nginx, mysql)">
                                </div>
                                <div class="icon-grid" id="icon-grid">
                                    <!-- Icons populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Upload Custom Image Section -->
                        <div class="upload-section">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="image_option" id="upload_custom" value="upload">
                                <label class="form-check-label" for="upload_custom">
                                    <i class="bi bi-upload"></i> Upload custom image
                                </label>
                            </div>
                            <div class="upload-input" id="upload-input" style="display: none;">
                                <input type="file" class="form-control" name="logo" accept="image/*">
                                <small class="form-text text-muted">PNG, JPG, GIF up to 2MB</small>
                            </div>
                        </div>

                        <!-- Hidden field for selected icon -->
                        <input type="hidden" name="logo_choice" id="logo_choice">
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Target *</label>
                                <input type="text" class="form-control" name="target" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Port</label>
                                <input type="number" class="form-control" name="port" min="1" max="65535">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Timeout (seconds)</label>
                                <input type="number" class="form-control" name="timeout" value="10" min="1" max="60">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Check Interval (seconds)</label>
                                <input type="number" class="form-control" name="check_interval" value="60" min="30" max="3600">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Connection</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Include the image selector JavaScript -->
<script src="{{ url_for('static', filename='js/image-selector.js') }}"></script>

<script>
// Simple, working JavaScript functions

function checkConnection(connectionId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Checking...';
    button.disabled = true;
    
    fetch('/api/connections/' + connectionId + '/check', {
        method: 'POST',
        credentials: 'same-origin'
    })
            .then(response => {
                return response.json();
            })
    .then(data => {
        if (typeof UpLite !== 'undefined' && UpLite.notify) {
            UpLite.notify.success('Connection checked successfully');
        } else {
            alert('Connection checked successfully');
        }
        setTimeout(() => location.reload(), 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        if (typeof UpLite !== 'undefined' && UpLite.notify) {
            UpLite.notify.error('Failed to check connection');
        } else {
            alert('Failed to check connection');
        }
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function editConnection(connectionId) {
    console.log("editConnection called with ID:", connectionId);
    const button = event.target.closest("button");
    const originalText = button.innerHTML;
    button.innerHTML = "<i class=\"bi bi-arrow-clockwise\"></i> Loading...";
    button.disabled = true;
    
    fetch("/api/connections/" + connectionId, {
        method: "GET",
        credentials: "same-origin"
    })
    .then(response => response.json())
    .then(data => {
        // Create an enhanced edit overlay with image selection
        createEnhancedEditOverlay(data);
        
        // Reset button
        button.innerHTML = originalText;
        button.disabled = false;
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Failed to load connection data");
        
        // Reset button on error
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function createEnhancedEditOverlay(data) {
    // Remove any existing overlay
    const existingOverlay = document.getElementById("editOverlay");
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    // Create overlay
    const overlay = document.createElement("div");
    overlay.id = "editOverlay";
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    // Create form container
    const formContainer = document.createElement("div");
    formContainer.style.cssText = `
        background: white;
        border-radius: 8px;
        padding: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    `;
    
    formContainer.innerHTML = `
        <h5>Edit Connection</h5>
        <form id="enhancedEditForm">
            <input type="hidden" id="editId" value="${data.id}">
            <div class="mb-3">
                <label class="form-label">Connection Name *</label>
                <input type="text" class="form-control" id="editName" value="${data.name}" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Description</label>
                <input type="text" class="form-control" id="editDesc" value="${data.description || ""}">
            </div>
            <div class="mb-3">
                <label class="form-label">Target *</label>
                <input type="text" class="form-control" id="editTarget" value="${data.target}" required>
            </div>
            
            <!-- Simplified image selection for edit form -->
            <div class="mb-3">
                <label class="form-label">Image Options</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="edit_image_option" id="edit_keep_current" value="keep" checked>
                    <label class="form-check-label" for="edit_keep_current">
                        Keep current image
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="edit_image_option" id="edit_upload_new" value="upload">
                    <label class="form-check-label" for="edit_upload_new">
                        Upload new image
                    </label>
                </div>
                <div id="edit_upload_section" style="display: none; margin-top: 0.5rem;">
                    <input type="file" class="form-control" id="editLogo" accept="image/*">
                    <small class="text-muted">Leave empty to keep current image</small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-warning">Update</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditOverlay()">Cancel</button>
            </div>
        </form>
    `;
    
    overlay.appendChild(formContainer);
    document.body.appendChild(overlay);
    
    // Add form handler
    document.getElementById("enhancedEditForm").addEventListener("submit", function(e) {
        e.preventDefault();
        submitEditForm(data.id);
    });
    
    // Handle image option changes for edit form
    document.querySelectorAll('input[name="edit_image_option"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const uploadSection = document.getElementById('edit_upload_section');
            if (this.value === 'upload') {
                uploadSection.style.display = 'block';
            } else {
                uploadSection.style.display = 'none';
            }
        });
    });
    
    // Close on overlay click
    overlay.addEventListener("click", function(e) {
        if (e.target === overlay) {
            closeEditOverlay();
        }
    });
}

function closeEditOverlay() {
    const overlay = document.getElementById("editOverlay");
    if (overlay) {
        overlay.remove();
    }
}

function submitEditForm(connectionId) {
    const formData = new FormData();
    formData.append("name", document.getElementById("editName").value);
    formData.append("description", document.getElementById("editDesc").value);
    formData.append("target", document.getElementById("editTarget").value);
    
    const logoFile = document.getElementById("editLogo").files[0];
    const imageOption = document.querySelector('input[name="edit_image_option"]:checked').value;
    
    if (imageOption === 'upload' && logoFile) {
        formData.append("logo", logoFile);
    }
    
    fetch("/api/connections/" + connectionId, {
        method: "PUT",
        credentials: "same-origin",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            alert("Connection updated successfully!");
            closeEditOverlay();
            location.reload();
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Failed to update connection");
    });
}

function deleteConnection(connectionId) {
    if (confirm('Are you sure you want to delete this connection?')) {
        fetch('/api/connections/' + connectionId, {
            method: 'DELETE',
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.ok) {
                if (typeof UpLite !== 'undefined' && UpLite.notify) {
                    UpLite.notify.success('Connection deleted');
                } else {
                    alert('Connection deleted');
                }
                location.reload();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof UpLite !== 'undefined' && UpLite.notify) {
                UpLite.notify.error('Failed to delete connection');
            } else {
                alert('Failed to delete connection');
            }
        });
    }
}

// Form handlers
document.addEventListener('DOMContentLoaded', function() {
    // Add connection form
    const addForm = document.getElementById('addConnectionForm');
    if (addForm) {
        addForm.addEventListener("submit", function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            console.log("Form fields:", Array.from(formData.entries()));
            
            // Convert empty strings to null for non-file fields
            if (!formData.get("port")) formData.delete("port");
            if (!formData.get("description")) formData.delete("description");
            
            fetch("/api/connections", {
                method: "POST",
                credentials: "same-origin",
                body: formData  // Send FormData directly for file upload support
            })
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    if (typeof UpLite !== "undefined" && UpLite.notify) {
                        UpLite.notify.error(data.error);
                    } else {
                        alert(data.error);
                    }
                } else {
                    if (typeof UpLite !== "undefined" && UpLite.notify) {
                        UpLite.notify.success("Connection added successfully");
                    } else {
                        alert("Connection added successfully");
                    }
                    
                    // Reset the image selector
                    if (window.addConnectionImageSelector) {
                        window.addConnectionImageSelector.reset();
                    }
                    
                    // Close modal and refresh
                    const modal = bootstrap.Modal.getInstance(document.getElementById("addConnectionModal"));
                    if (modal) modal.hide();
                    location.reload();
                }
            })
            .catch(error => {
                console.error("Error:", error);
                if (typeof UpLite !== "undefined" && UpLite.notify) {
                    UpLite.notify.error("Failed to add connection");
                } else {
                    alert("Failed to add connection");
                }
            });
        });
    }
});
</script>
{% endblock %}

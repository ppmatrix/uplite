<!-- Dashboard Template - Updated: 2025-08-16 16:15 -->
{% extends "base.html" %}

{% block title %}Dashboard - UpLite{% endblock %}

{% block head %}
<style>
.widget-container {
    margin-bottom: 20px;
}

.widget {
    background: transparent;
    border: none;
    box-shadow: none;
}

.widget-header {
    background: var(--widget-header-bg);
    border-bottom: 1px solid var(--border-color);
    border-radius: 8px 8px 0 0;
    padding: 15px 20px;
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--text-color);
    transition: background 0.3s ease, color 0.3s ease;
}

.widget-body {
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: 12px;
    transition: background-color 0.3s ease;
}

.connection-summary {
    margin-bottom: 25px;
}

/* 5-Column Connection Layout */
.connection-item {
    display: flex;
    align-items: center;
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-secondary);
    box-shadow: 0 1px 3px var(--shadow);
    transition: all 0.3s ease;
    cursor: pointer;
    text-decoration: none;
    color: var(--text-color);
    min-height: 50px;
    height: 100%;
    width: 100%;
}

.connection-column {
    display: flex;
    align-items: center;
    height: 100%;
}

.connection-column {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Column 1: Logo */
.connection-logo {
    width: 40px;
    justify-content: center;
    flex-shrink: 0;
    margin-right: 8px;
}

.connection-logo-img {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    object-fit: cover;
}

/* Column 2: Connection Info */
.connection-info {
    flex: 1;
    min-width: 100px;
    padding-left: 6px;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
}

/* Column 3: Chart */
.connection-chart {
    width: 75px;
    justify-content: center;
    flex-shrink: 0;
    margin: 0 4px;
}

/* Column 4: Time Badge */
.connection-time {
    width: 55px;
    justify-content: center;
    flex-shrink: 0;
    margin-left: 6px;
}

/* Column 5: External Link */
.connection-link {
    width: 18px;
    justify-content: center;
    flex-shrink: 0;
    margin-left: 6px;
}

.link-placeholder {
    width: 16px;
    height: 16px;
}

.connections-list {
    margin-left: -15px;
    margin-right: -15px;
}

.connections-list .col-lg-6 {
    padding-left: 15px;
    padding-right: 15px;
}

.non-clickable {
    cursor: default !important;
}

.non-clickable:hover {
    transform: none !important;
    background: var(--bg-secondary) !important;
    border-color: var(--border-color) !important;
    box-shadow: none !important;
}

/* Connection Info */
.connection-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    line-height: 1.2;
    transition: color 0.3s ease;
}

.connection-description {
    color: var(--text-muted);
    font-size: 0.8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    line-height: 1.1;
    margin-top: -2px;
    transition: color 0.3s ease;
}

/* Connection Status Colors */
.status-up {
    border-left: 4px solid #28a745;
    background: rgba(40, 167, 69, 0.1);
}

.status-down {
    border-left: 4px solid #dc3545;
    background: rgba(220, 53, 69, 0.1);
}

.status-unknown {
    border-left: 4px solid #6c757d;
    background: rgba(108, 117, 125, 0.1);
}

.connection-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: var(--primary-color);
}

/* Scrolling line chart */
.ping-chart-container {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 20px;
    width: 80px;
    background: transparent;
}

.no-chart-data {
    color: var(--text-muted);
    font-size: 1.0rem;
    text-align: center;
    width: 100%;
    transition: color 0.3s ease;
}

.chart-line {
    fill: none;
    stroke: #059669;
    stroke-width: 1.5;
    vector-rendering: crispEdges;
    filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1));
}

.clean-dashboard-title {
    color: var(--text-color);
    font-weight: 600;
    margin-bottom: 30px;
    text-shadow: 0 1px 2px var(--shadow);
    transition: color 0.3s ease;
}

.refresh-btn {
    box-shadow: 0 2px 4px var(--shadow);
}

.external-link-icon {
    margin-left: 10px;
    color: var(--primary-color);
    font-size: 1.1rem;
    opacity: 0.6;
    transition: opacity 0.3s ease;
}

.non-clickable .external-link-icon {
    display: none;
}

/* System Status Widget Styles */
.system-metric {
    margin-bottom: 1rem;
}

.system-metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.system-metric-title {
    font-weight: 600;
    font-size: 0.9rem;
}

.system-progress {
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
}

.system-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.system-info-card {
}

/* Logs Viewer Widget Styles */
.log-content-area {
    max-height: 400px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.85rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    padding: 1rem;
    border-radius: 4px;
    color: var(--text-color);
}

.log-entry {
    margin-bottom: 0.25rem;
    word-wrap: break-word;
    color: var(--text-color);
    line-height: 1.4;
}

.log-content-area .text-muted {
    color: var(--text-muted) !important;
    background: var(--bg-primary);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .connection-item {
        min-height: 60px;
        padding: 10px 15px;
    }
    
    .connection-name {
        font-size: 1.1rem;
    }
    
    .connection-description {
        font-size: 1.0rem;
    }
}

@media (min-width: 1200px) {
    .connections-list .col-lg-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
    }
}

@media (min-width: 992px) and (max-width: 1199px) {
    .connections-list .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="clean-dashboard-title"><i class="bi bi-speedometer2"></i> Dashboard</h1>
    <button id="refresh-dashboard" class="btn btn-outline-primary refresh-btn">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
</div>

<div class="row" id="dashboard-widgets">
    {% for widget_config in widget_configs %}
    <div class="col-12 widget-container">
        <div class="widget widget-{{ widget_config.widget_type }}" data-widget-id="{{ widget_config.id }}" data-widget-type="{{ widget_config.widget_type }}">
            <div class="widget-header">
                <i class="bi bi-{% if widget_config.widget_type == 'system_status' %}cpu{% elif widget_config.widget_type == 'connection_monitor' %}activity{% elif widget_config.widget_type == 'service_status' %}hdd-network{% elif widget_config.widget_type == 'logs_viewer' %}journal-text{% else %}puzzle{% endif %}"></i>
                {{ widget_config.widget_title or widget_config.widget_type.replace('_', ' ').title() }}
            </div>
            <div class="widget-body" id="widget-{{ widget_config.id }}-body">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading {% if widget_config.widget_type == "system_status" %}system status{% elif widget_config.widget_type == "connection_monitor" %}connection status{% elif widget_config.widget_type == "service_status" %}service status{% elif widget_config.widget_type == "logs_viewer" %}logs{% else %}widget data{% endif %}...</p>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Welcome to UpLite Dashboard</strong><br>
            Your dashboard is ready! Visit the <a href="{{ url_for('dashboard.widgets') }}" class="alert-link"><i class="bi bi-puzzle"></i> Widgets page</a> to add widgets and customize your experience.
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load widget data
    loadAllWidgets();
    
    // Set up refresh button
    document.getElementById('refresh-dashboard').addEventListener('click', function() {
        const button = this;
        const originalHtml = button.innerHTML;
        button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Refreshing...';
        button.disabled = true;
        
        loadAllWidgets().finally(() => {
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
    });
    
    // Auto-refresh every 30 seconds
    setInterval(loadAllWidgets, 30000);
});

function loadAllWidgets() {
    const widgets = document.querySelectorAll('.widget[data-widget-id]');
    const promises = [];
    
    widgets.forEach(widget => {
        const widgetId = widget.getAttribute('data-widget-id');
        const widgetType = widget.getAttribute('data-widget-type');
        promises.push(loadWidgetData(widgetId, widgetType));
    });
    
    return Promise.all(promises);
}

function loadWidgetData(widgetId, widgetType) {
    const widgetBody = document.getElementById(`widget-${widgetId}-body`);
    
    // Special handling for connection_monitor widget - use dashboard refresh
    if (widgetType === "connection_monitor") {
        return fetch(`/api/dashboard/refresh`)
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    throw new Error("Authentication required - please refresh the page and login");
                }
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    widgetBody.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
                } else {
                    renderConnectionMonitor(data, widgetBody);
                }
            })
            .catch(error => {
                console.error(`❌ Error loading ${widgetType} widget:`, error);
                widgetBody.innerHTML = `<div class="alert alert-danger"><i class="bi bi-wifi-off"></i> Failed to load widget data: ${error.message}</div>`;
            });
    } else {
        // For other widgets, use the widget-specific API
        return fetch(`/api/widgets/${widgetId}/data`)
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    throw new Error("Authentication required - please refresh the page and login");
                }
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    widgetBody.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
                } else {
                    renderWidget(widgetType, data, widgetBody);
                }
            })
            .catch(error => {
                console.error(`❌ Error loading ${widgetType} widget:`, error);
                widgetBody.innerHTML = `<div class="alert alert-danger"><i class="bi bi-wifi-off"></i> Failed to load widget data: ${error.message}</div>`;
            });
    }
}

function renderWidget(widgetType, data, container) {
    switch (widgetType) {
        case 'system_status':
            renderSystemStatus(data, container);
            break;
        case 'connection_monitor':
            renderConnectionMonitor(data, container);
            break;
        case 'service_status':
            renderServiceStatus(data, container);
            break;
        case 'logs_viewer':
            renderLogsViewer(data, container);
            break;
        default:
            container.innerHTML = `<div class="alert alert-warning">Unknown widget type: ${widgetType}</div>`;
    }
}

// Connection Monitor rendering function - handles both signatures
function renderConnectionMonitor(data, container) {
    // If called with only one parameter, find the container
    if (!container) {
        container = document.querySelector('[data-widget-type="connection_monitor"] .widget-body');
        if (!container) {
            console.error("❌ Cannot find connection monitor container");
            return;
        }
    }
    
    if (!data) {
        console.error("❌ No data provided to renderConnectionMonitor");
        container.innerHTML = '<div class="alert alert-danger">No data received from API</div>';
        return;
    }
    
    if (!data.connections || data.connections.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Get started by adding connections to monitor your services. <a href="/dashboard/connections" class="alert-link"><i class="bi bi-plus-circle"></i> Go to Connections page</a> to create your first connection.</div>';
        return;
    }
    
    // Generate summary section from connection data
    const upCount = data.connections.filter(conn => conn.last_status === 'up').length;
    const downCount = data.connections.filter(conn => conn.last_status === 'down').length;
    const totalCount = data.connections.length;
    
    const overallStatus = downCount === 0 ? 'success' : (upCount === 0 ? 'danger' : 'warning');
    const overallMessage = downCount === 0 ? 'All services operational' : 
                          upCount === 0 ? 'All services down' : 
                          `${downCount} service${downCount > 1 ? 's' : ''} experiencing issues`;

    const summaryHtml = `
        <div class="connection-summary">
            <div class="alert alert-${overallStatus} d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <strong class="me-3"><i class="bi bi-hdd-network"></i> ${overallMessage}</strong>
                    <small>
                        <span class="badge bg-secondary me-2">Total: ${totalCount}</span>
                        <span class="badge bg-success me-2">Up: ${upCount}</span>
                        ${downCount > 0 ? `<span class="badge bg-danger me-2">Down: ${downCount}</span>` : ''}
                        ${data.connections.filter(conn => conn.last_status === 'unknown').length > 0 ? `<span class="badge bg-warning me-2">Unknown: ${data.connections.filter(conn => conn.last_status === 'unknown').length}</span>` : ''}
                    </small>
                </div>
                <div class="text-end">
                    <small class="text-muted">
                        <i class="bi bi-clock"></i> 
                        Updated ${new Date().toLocaleTimeString()}
                    </small>
                </div>
            </div>
        </div>
    `;
    
    // Generate connections list with all the original functionality
    let connectionsHtml = '<div class="connections-list row">';
    
    // Generate sample historical data as fallback when no real data available
    function generateSampleHistory(conn) {
        const baseTime = conn.median_response_time || conn.last_response_time || 100;
        const variance = baseTime * 0.3;
        const history = [];
        
        for (let i = 0; i < 20; i++) {
            const time = baseTime + (Math.random() - 0.5) * variance;
            const status = Math.random() > 0.1 ? 'up' : 'down';
            history.push({
                timestamp: Date.now() - (20 - i) * 60000,
                last_response_time: Math.max(1, time),
                status: status
            });
        }
        return history;
    }
    
    // Create ultra-minimal SVG line chart
    function createSVGChart(history, currentStatus) {
        const width = 80;
        const height = 20;
        
        const validData = history.filter(h => {
            const responseTime = h.response_time || h.last_response_time;
            const status = h.status;
            return responseTime && status === 'up';
        });
        
        if (validData.length < 2) {
            return `<div class="no-chart-data">—</div>`;
        }
        
        const responseTimes = validData.map(h => h.response_time || h.last_response_time);
        const minTime = Math.min(...responseTimes);
        const maxTime = Math.max(...responseTimes);
        const timeRange = maxTime - minTime || 1;
        
        const pathData = validData.map((h, i) => {
            const responseTime = h.response_time || h.last_response_time;
            const x = (i / (validData.length - 1)) * width;
            const y = height - ((responseTime - minTime) / timeRange) * height;
            return `${i === 0 ? 'M' : 'L'}${x},${y}`;
        }).join(' ');
        
        const color = currentStatus === 'up' ? '#059669' : '#dc2626';
        
        return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" style="display:block;background:transparent;"><path d="${pathData}" fill="none" stroke="${color}" stroke-width="1" vector-rendering="crispEdges"/></svg>`;
    }

    function isClickableUrl(url) {
        if (!url) return false;
        if (url.startsWith('http://') || url.startsWith('https://')) return true;
        if (/^\d+\.\d+\.\d+\.\d+$/.test(url)) return false;
        return false;
    }

    function buildConnectionUrl(conn) {
        let url = conn.target;
        if (conn.port && !url.includes(":" + conn.port)) {
            if (url.startsWith("http://") || url.startsWith("https://")) {
                try {
                    const urlObj = new URL(url);
                    if (!urlObj.port) {
                        urlObj.port = conn.port;
                        url = urlObj.toString();
                    }
                } catch (e) {
                    url = url + ":" + conn.port;
                }
            } else {
                url = url + ":" + conn.port;
            }
        }
        if (!url.startsWith("http://") && !url.startsWith("https://")) {
            url = "https://" + url;
        }
        return url;
    }

    function makeConnectionClickable(element, url, connectionName) {
        if (!isClickableUrl(url)) {
            element.classList.add('non-clickable');
            return;
        }
        element.addEventListener('click', function(e) {
            e.preventDefault();
            window.open(url, '_blank', 'noopener,noreferrer');
        });
    }
    
    data.connections.forEach((conn, index) => {
        const isClickable = isClickableUrl(conn.target);
        const statusClass = conn.last_status === 'up' ? 'status-up' : conn.last_status === 'down' ? 'status-down' : 'status-unknown';
        
        const generateChart = (conn) => {
            const historyData = conn.history && conn.history.length > 0 ? conn.history : generateSampleHistory(conn);
            return createSVGChart(historyData, conn.last_status);
        };
        
        connectionsHtml += `
        <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
            <div class="connection-item ${statusClass}" data-url="${buildConnectionUrl(conn)}" data-name="${conn.name}">
                <div class="connection-column connection-logo">
                    ${conn.logo_filename ? `<img src="/static/images/connections/${conn.logo_filename}" alt="${conn.name}" class="connection-logo-img">` : ""}
                </div>
                <div class="connection-column connection-info">
                    <div class="connection-name">${conn.name}</div>
                    <div class="connection-description">${conn.description || conn.target}</div>
                </div>
                <div class="connection-column connection-chart">
                    <div class="ping-chart-container">${generateChart(conn)}</div>
                </div>
                <div class="connection-column connection-time">
                    ${(() => {
                    const responseTime = conn.median_response_time || conn.last_response_time;
                    if (!responseTime) {
                        return '<div class="response-time-display badge bg-danger">ERR</div>';
                    }
                    let colorClass = 'badge bg-danger';
                    if (responseTime < 100) colorClass = 'badge bg-success';
                    else if (responseTime < 300) colorClass = 'badge bg-warning text-dark';
                    else if (responseTime < 1000) colorClass = 'badge bg-warning';
                    const roundedTime = Math.round(responseTime);
                    const title = conn.median_response_time ? 'Median response time' : 'Current response time';
                    return `<div class="response-time-display ${colorClass}" title="${title}">${roundedTime}ms</div>`;
                })()}
                </div>
                <div class="connection-column connection-link">
                    ${isClickable ? '<i class="bi bi-box-arrow-up-right external-link-icon"></i>' : '<span class="link-placeholder"></span>'}
                </div>
            </div>
        </div>`;
    });
    connectionsHtml += '</div>';
    
    container.innerHTML = summaryHtml + connectionsHtml;
    
    // Add click handlers to clickable connections
    const connectionItems = container.querySelectorAll('.connection-item');
    connectionItems.forEach(item => {
        const url = item.dataset.url;
        const name = item.dataset.name;
        makeConnectionClickable(item, url, name);
    });
}

function renderSystemStatus(data, container) {
    if (data.error) {
        container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
        return;
    }

    const cpuStatus = data.cpu.status;
    const memoryStatus = data.memory.status;
    const diskStatus = data.disk.status;

    const html = `
        <div class="system-info-grid">
            <div class="system-info-card">
                <div class="system-metric">
                    <div class="system-metric-header">
                        <span class="system-metric-title"><i class="bi bi-cpu"></i> CPU Usage</span>
                        <span class="badge bg-${cpuStatus}">${data.cpu.percent}%</span>
                    </div>
                    <div class="progress system-progress">
                        <div class="progress-bar bg-${cpuStatus}" style="width: ${data.cpu.percent}%"></div>
                    </div>
                    <small class="text-muted">${data.cpu.count} cores available</small>
                </div>
            </div>
            
            <div class="system-info-card">
                <div class="system-metric">
                    <div class="system-metric-header">
                        <span class="system-metric-title"><i class="bi bi-memory"></i> Memory Usage</span>
                        <span class="badge bg-${memoryStatus}">${data.memory.percent}%</span>
                    </div>
                    <div class="progress system-progress">
                        <div class="progress-bar bg-${memoryStatus}" style="width: ${data.memory.percent}%"></div>
                    </div>
                    <small class="text-muted">${data.memory.used_gb}GB / ${data.memory.total_gb}GB used</small>
                </div>
            </div>
            
            <div class="system-info-card">
                <div class="system-metric">
                    <div class="system-metric-header">
                        <span class="system-metric-title"><i class="bi bi-hdd"></i> Disk Usage</span>
                        <span class="badge bg-${diskStatus}">${data.disk.percent}%</span>
                    </div>
                    <div class="progress system-progress">
                        <div class="progress-bar bg-${diskStatus}" style="width: ${data.disk.percent}%"></div>
                    </div>
                    <small class="text-muted">${data.disk.used_gb}GB / ${data.disk.total_gb}GB used</small>
                </div>
            </div>
            
            <div class="system-info-card">
                <div class="system-metric">
                    <div class="system-metric-header">
                        <span class="system-metric-title"><i class="bi bi-clock"></i> System Info</span>
                        <span class="badge bg-info">${data.system.platform}</span>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted d-block">Uptime: ${data.system.uptime_days}d ${data.system.uptime_hours}h ${data.system.uptime_minutes}m</small>
                        <small class="text-muted d-block">Boot: ${data.system.boot_time}</small>
                        <small class="text-muted d-block">Release: ${data.system.release}</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-end mt-3">
            <small class="text-muted">
                <i class="bi bi-clock"></i> 
                Updated ${new Date(data.timestamp).toLocaleTimeString()}
            </small>
        </div>
    `;

    container.innerHTML = html;
}

function renderServiceStatus(data, container) {
    if (data.error) {
        container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
        return;
    }

    if (!data.services || data.services.length === 0) {
        container.innerHTML = `<div class="alert alert-info"><i class="bi bi-info-circle"></i> No services configured for monitoring</div>`;
        return;
    }

    // Summary section
    const summaryHtml = `
        <div class="service-summary mb-3">
            <div class="alert alert-${data.summary.overall_status} d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <strong class="me-3"><i class="bi bi-gear"></i> Service Status</strong>
                    <small>
                        <span class="badge bg-secondary me-2">Total: ${data.summary.total}</span>
                        <span class="badge bg-success me-2">Running: ${data.summary.running}</span>
                        ${data.summary.stopped > 0 ? `<span class="badge bg-danger me-2">Stopped: ${data.summary.stopped}</span>` : ''}
                    </small>
                </div>
                <div class="text-end">
                    <small class="text-muted">
                        <i class="bi bi-clock"></i> 
                        Updated ${new Date(data.timestamp).toLocaleTimeString()}
                    </small>
                </div>
            </div>
        </div>
    `;

    // Services list
    let servicesHtml = '<div class="services-list row">';
    data.services.forEach(service => {
        const statusIcon = service.is_running ? 'play-circle-fill' : 'stop-circle-fill';
        const statusText = service.is_running ? 'Running' : 'Stopped';
        const enabledText = service.is_enabled ? 'Enabled' : 'Disabled';
        
        servicesHtml += `
            <div class="col-lg-6 col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-1">
                                    <i class="bi bi-${statusIcon} text-${service.status_color} me-2"></i>
                                    ${service.name}
                                </h6>
                                <div>
                                    <span class="badge bg-${service.status_color}">${statusText}</span>
                                    <span class="badge bg-secondary ms-1">${enabledText}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    servicesHtml += '</div>';

    container.innerHTML = summaryHtml + servicesHtml;
}

function renderLogsViewer(data, container) {
    if (data.error) {
        container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
        return;
    }

    if (!data.logs || data.logs.length === 0) {
        container.innerHTML = `<div class="alert alert-info"><i class="bi bi-info-circle"></i> No log files available or accessible</div>`;
        return;
    }

    // Header with summary
    let html = `
        <div class="logs-summary mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6><i class="bi bi-journal-text"></i> Recent Log Entries</h6>
                <div>
                    <small class="text-muted">
                        ${data.total_entries} entries from ${data.logs.length} sources
                    </small>
                </div>
            </div>
        </div>
    `;

    // Logs tabs
    html += `<ul class="nav nav-tabs" id="logsTab" role="tablist">`;
    data.logs.forEach((log, index) => {
        html += `
            <li class="nav-item" role="presentation">
                <button class="nav-link ${index === 0 ? 'active' : ''}" 
                        id="log-${index}-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#log-${index}" 
                        type="button" role="tab">
                    ${log.name} (${log.count})
                </button>
            </li>
        `;
    });
    html += `</ul>`;

    // Logs content
    html += `<div class="tab-content" id="logsTabContent">`;
    data.logs.forEach((log, index) => {
        html += `
            <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" 
                 id="log-${index}" role="tabpanel">
                <div class="log-content mt-3 log-content-area">
        `;
        
        if (log.entries && log.entries.length > 0) {
            log.entries.forEach(entry => {
                if (entry.trim()) {
                    html += `<div class="log-entry">${escapeHtml(entry)}</div>`;
                }
            });
        } else {
            html += `<div class="text-muted">No entries available</div>`;
        }
        
        html += `</div></div>`;
    });
    html += `</div>`;

    // Update timestamp
    html += `
        <div class="text-end mt-3">
            <small class="text-muted">
                <i class="bi bi-clock"></i> 
                Updated ${new Date(data.timestamp).toLocaleTimeString()}
            </small>
        </div>
    `;

    container.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
